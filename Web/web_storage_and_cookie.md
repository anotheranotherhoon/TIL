# 웹스토리지 & 쿠키
> 동영상주소 :  https://www.youtube.com/watch?v=-4ZsGy1LOiE 디토님의 웹스토리지 & 쿠키
## 1. 쿠키
* 쿠키는 브라우저에 저장되는 작은 크기의 문자열(최대 4KB까지 저장 할 수 있다.)

## 1-1. 쿠키의 역사
* 쿠키의 이름은 웹 프로그래머 루 몬틀리가 유닉스 프로그래머들이 사용한 매직쿠키라는 단어에서 영감을 얻어 사용하게 되었다. 

쿠키가 처음 사용되었던 이유는 넷스케이프 웹사이트 방문자가 이미 사이트를 방문했었는지 여부를 판단하기 위함이었다.

만약 쿠키가 없다면  방문을 했던 사용자 인지 알 수 가 없다.

이는 http의 특성 때문이다.

http는 비연결성, 무상태성의 특성을 가지고 있다. 

간단하게 클라이언트와 서버가 한 번 연결을 맺은 뒤에 요청과 응답이 끝나면 연결을 끊고 상태를 유지하지도 않기 때문에 현재 요청하는 사용자의 정보를 알 수 없다.
하지만 넷스케이프는 현재 사용자가 사이트에 방문했었는지 여부를 판단해야 고했 이로 인해 쿠키가 등장 한 것입니다.

## 1-2. 쿠키의 특징

* 1. 주로 서버에서 사용됩니다.
* 2. 또한 http 요청시 headerS에 실려서 전송되는 특징이 있다. 이때 같은 도메인에서 만들어진 쿠키만 전송하게 됩니다.
* 3. 만료 기간 지정가능
> Set-Cookie: cookie-name = cookie-value; Expires=date

> Set-Cookie: cookie-name = cookie-value; Max-Age=date

> 만약 Expires와 Max-Age둘다 존재한다면 Expires는 무시된다.

## 1-3. 쿠키의 종류 (만료기간에 따른 구분) 
* 쿠키는 만료기간에 따라 영구쿠키와 세션쿠키로 나뉜다.
* 만료기간을 정한 쿠키를 영구 쿠키.
* 영구 쿠키는 브라우저가 종료되도 삭제 되지 않고 만료기간이 끝나지 않으면 삭제 되지 않는다. 만료기간이 끝난 후 삭제된다.
* 만료기간이 없는 쿠키를 세션쿠키 라고 한다. 브라우저 종료 시 삭제된다.


## 1-4. 쿠키의 종류 (도메인에 따른 구분)
* 퍼스트파티쿠키와 서드파티 쿠키로 나누기도 한다.
* 퍼스트 파티 쿠키는 같은 도메인에서 생성된 쿠키를 말한다.(서브 도메인인 경우도 포함한다.) 예시 naver.com/m.naver.com
* 서드 파티 쿠키는 다른 도메인에서 생성된 쿠키이다.

* 서드파티 쿠키는 주로 광고 목적으로 사용됩니다. (사용자의 방문 사이트 파악 = 광고)
* 사용자가 어떤 사이트를 방문했었는지 알 수 있기 때문이다.
* 하지만 이것은 프라이버시를 침해하고 개인정보 악용에 대한 우려가 있기 때문에 크롬에서는 서드파티 쿠키의 지원을 중단하겠다는 계획을 발표 하기도 했다.

## 1-5. 쿠키의 문제점
1. CSRF 사용자의 권한을 이용한 공격(비밀번호 변경, 결제 요청 등)
쿠키가 자동으로 전송된다는 특징을 이용해서 사이트에 로그인이 되어있는 사용자에게 악성스크립트를 실행시켜 비밀번호를 변경하거나 결제 요청을 하는데 악의적인 요청을 하는 것입니다. 

2. XSS Reflected XSS, Stored XSS, DOM-based XSS 사용자의 민감한 정보 탈취(토큰)
악성 스크립트를 실행시켜서 사용자의 토큰과 같은 민감한 정보를 탈취하는 것입니다. 

3. 부족한 저장 용량 4KB

4. HTTP 요청 시 자동으로 모든 쿠키 전송  (불필요한 트래픽 증가)



## 2. 웹 스토리지
* 쿠키의 문제점들을 해결 할 수 있는 웹스토리지가 html5에 등장했다.

## 2-1. 웹스토리지의 특징
* 1. 5mb의 저장 용량 
> 쿠키의 부족한 저장 용량 문제 해결

* 2. 요청 시 headers에 전송하지 않음 
> 쿠키의 CSRF, 트래픽 문제 해결

* 3. 문자열만 저장 가능
> 직렬화를 통해 객체 저장 가능

## 2-2. 웹스토리지의 종류
* 웹 스토리지는 로컬 스터리지와 세션스토리지가 있다.

* 로컬스토리지
>저장범위 도메인/ 브라우저

>삭제시기 직접 삭제 시

* 세션 스토리지
> 저장범위 도메인/브라우저/탭

> 삭제시기 탭 종시 료

로컬스토리지와 세션스토리지는 동기적으로 실행된다.

## 2-3. 웹스토리지 사용시 고려할 점
* 웹스토리지는 문자열만 저장이 가능하다. 
>따라서 객체를 사용하기 위해서는 직렬화, 역직렬화 과정이 필요하다.

* 직렬화를 할 때 순환 참조이거나, 역직렬화를 할 때 json 형식이 아닌 경우에는 
에러가 발생한다. 

* 대부분의 브라우저는 웹스토리지를 지원하지만 버전에 따라 웹스토리지를 지원하지 않을 수 있다.

* 웹스토리지를 지원한다고 해도 웹스토리지를 비활성화 할 수 있는 기능을 제공하는 브라우저도 존재하기 때문에 에러가 발생 할 수 있다.

* 사파리브라우저에서 시크릿모드로 접속시 스토리지 할당량이 0으로 설정 되기 때문에 할당량 초과라는 에러가 발생하게 된다.

* 즉 웹스토리지를 사용할 때는 반드시 에러 처리를 해야한다.

## 2-4. 웹스토리의 단점
* 쿠키의 문제점은 바로 잡았지만 웹스토리지가 완벽하지는 않다.
* 웹스토리지도 쿠키와 마찬가지로 XSS에 취약하다.
* 또한 브라우저간 공유가 되지 않기에 다른 브라우저가 접속하거나 데스크탑과 모바일에서 다른 데이터를 볼 수도 있다.
* 만료기간 설정 불가
* 마지막으로 이들은 동기적으로 실행되기 때문에 메인 스레드를 블록킹하게 된다.
>따라서 큰 데이터를 다루는 것을 주의해야한다.

>용량이 큰 경우 indexDB를 고려해볼 필요가 있습니다.

쿠키나 웹스토리지를 사용 할 때는 각각의 특징을 잘 파악해서 적절한 사용처에서 사용하는 것이 중요하다.

## 정리
### 사용처
>보안 문제가 있기 때문에 민감한 정보는 저장하지 않는것이 바람직하다. 

* 쿠키는 기간을 설정해야 하거나 자동으로 서버로 전성되어야 하는 작은 용량의 데이터인 경우에 사용할 수 있습니다.
* 쿠키
(기간 설정, 서버 송전(작은 용량)) n일 동안 보지 않기, 비로그인 장바구니
세션 스토리지
(탭 종료시 삭제되어도 ok)
이전 페이지 저장/ 이전 스크롤 위치 저장

* 로컬 스토리지
> 브라우저 종료시에도 유지되어야 한다
> 사용자 설정 저장/ 글 임시 저장
중요한 것은 쿠키와 웹스토리지 특징을 잘 파악해서 개발중인 프로젝트 성격에 알맞게 사용하는 것이다.

* 쿠키 보안문제 해결 방안

* 쿠키의 XSS는 HttpOnly 옵션을 적용하면 해결할 수 있다.
* HttpOnly로 설정하면 자바스크립트로 접근할 수 없기 때문이다.

* CSRF는 쿠키의 SameSite옵션을(같은 도메인의 요청에만 쿠키를 전송) (즉, 악의적인 사이트에서 시작되는 공격이 통하지 않는다.)적용하거나 samesite는 strict와 lax옵션이 있는데 strict는 다른 도메인에서 들어온 모든 요청에 대해 쿠키를 전송하지 않는 것이고 lax는 a태그와 같은 링크를 클릭해서 접속하는 안전한 GET요청인 경우에만 쿠키를 전송하는 것이다.chrome은 기본적으로 lax 옵션이 설정되어 있기 때문에 CSRF에 어느 정도 대처가 되어 있습니다. 
* Referer를(요청온  사이트의 도메인을 확인할 수 있다) 검증한다면 해결 할 수있다.
* 웹스토리지에 XSS를 방어하는 가장 좋은 방법은 사용자의 입력이 자바스크립트 코드로 실행될 수 있는 코드를 작성하지 않는것이다.
* innerHTML을 사용한다면 공격이 가능한 script 태그나 image태그와 같은 각종 태그를 삽입 할 수 있기 때문에 공격을 당할 수 있다.
* 즉 innerHTML과 같은 코드를 사용하지 않는 것이 바람직 하다.

* 하지만 이를 사용해야하는 상황이라면XSS보안 라이브러리인 sanitize-html이나 DOMPurify같은 라이브러리를 사용하는 것을 추천한다. 
